- name: Update apt
  apt:
    update_cache: yes
    upgrade: dist

- name: Install base packages
  apt:
    name: 
      - nginx
      - curl
      - gnupg
      - build-essential
      - vim
      - certbot
      - python3-certbot-nginx
    state: present

- name: Install Node.js 20
  shell: curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt install -y nodejs
  args:
    creates: /usr/bin/node

- name: Create app directory
  file:
    path: "{{ app_dir }}"
    state: directory

- name: Create Node.js app
  copy:
    dest: "{{ app_dir }}/aws_rds.js"
    content: |
      const http = require('http');
      const PORT = {{ node_port }};
      const server = http.createServer((req, res) => {
        if (req.url === '/users') {
          res.writeHead(200, {'Content-Type': 'application/json'});
          res.end(JSON.stringify([]));
        } else {
          res.writeHead(404);
          res.end('Not Found');
        }
      });
      server.listen(PORT, () => console.log('Server running on port', PORT));

- name: Install PM2 globally
  npm:
    name: pm2
    global: yes

- name: Start Node.js app with PM2
  shell: pm2 start {{ app_dir }}/aws_rds.js --name node_app || pm2 restart node_app

- name: Ensure PM2 startup on boot
  shell: sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu && pm2 save

- name: Configure Nginx reverse proxy
  copy:
    dest: /etc/nginx/sites-available/aws_rds
    content: |
      server {
        listen 80;
        server_name _;

        location / {
          proxy_pass http://127.0.0.1:{{ node_port }};
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_cache_bypass $http_upgrade;
        }
      }

- name: Enable site and restart Nginx
  file:
    src: /etc/nginx/sites-available/aws_rds
    dest: /etc/nginx/sites-enabled/aws_rds
    state: link
  notify:
    - restart nginx

- name: Remove default Nginx config
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: Ensure Nginx is running
  service:
    name: nginx
    state: started
    enabled: yes

# Handlers
- name: restart nginx
  service:
    name: nginx
    state: restarted
